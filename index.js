const {Telegraf, Markup, session} = require('telegraf')
require('dotenv').config()
const help = require('./help')
const description = require('./description')
const callback = require('./callback')

const bot = new Telegraf(process.env.BOT_TOKEN)         //–¢–æ–∫–µ–Ω –±–æ—Ç–∞

// –î–æ–±–∞–≤–ª—è–µ–º middleware –¥–ª—è —Å–µ—Å—Å–∏–π
bot.use(session())

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
bot.use((ctx, next) => {
    // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    ctx.session = ctx.session || {
        paymentStatus: false,
        waitingForPost: false,
        messageToForward: null,
        messageType: null
    }
    return next()
})

bot.start(async (ctx) => await ctx.reply(`–ü—Ä–∏–≤–µ—Ç! ${ctx.from.first_name ? ctx.from.first_name : '–ù–µ–∑–Ω–∞–∫–æ–º–µ—Ü'}, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏`, Markup.keyboard([
    ['üìù –†–µ–∫–ª–∞–º–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è'],
    ['üìä –ü—Ä–∞–≤–∏–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'üìå –ü–æ–º–æ—â—å'],
]).resize()))

bot.help((ctx) => ctx.reply(help.helpcommands))

bot.command('post', async (ctx) => {
    await ctx.reply((description.description), Markup.inlineKeyboard(
        [
            [Markup.button.callback('–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π', 'adPost')],
        ]
    ))
})

bot.action('adPost', async (ctx) => {
    await ctx.answerCbQuery()
    return ctx.replyWithInvoice(getInvoice(ctx.from.id))
})

bot.hears('üìù –†–µ–∫–ª–∞–º–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è', async (ctx) => {
    return ctx.replyWithInvoice(getInvoice(ctx.from.id))
})

bot.hears('üìä –ü—Ä–∞–≤–∏–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', (ctx) => ctx.reply(description.description))
bot.hears('üìå –ü–æ–º–æ—â—å', (ctx) => ctx.reply(help.helpcommands))
bot.hears('–æ–ø–ª–∞—Ç–∏—Ç—å', (ctx) => {
    return ctx.replyWithInvoice(getInvoice(ctx.from.id))
})

const getInvoice = (id) => {
    const invoice = {
        chat_id: id,
        provider_token: process.env.PROVIDER_TOKEN,
        start_parameter: 'get_access',
        title: '–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
        description: '–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª–µ @baraxolka_krd',
        currency: 'RUB',
        protect_content: true,
        prices: [{label: '–û–ø–ª–∞—Ç–∞ –∑–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –æ–±—ä—è–≤–ª–µ–Ω–∏—è', amount: 100 * 100}],
        payload: {
            unique_id: `${id}_${Number(new Date())}`,
            provider_token: process.env.PROVIDER_TOKEN
        }
    }

    return invoice
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ pre-checkout query
bot.on('pre_checkout_query', (ctx) => ctx.answerPreCheckoutQuery(true))

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
bot.on('successful_payment', async (ctx) => {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –≤ —Å–µ—Å—Å–∏–∏
    ctx.session.paymentStatus = true

    await ctx.reply((callback.callback), Markup.inlineKeyboard(
        [
            [Markup.button.callback('>>> –ì–æ—Ç–æ–≤–æ? –ñ–º–∏ üé¨ <<<', 'readyPost')],
        ]
    ))
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ì–æ—Ç–æ–≤–æ"
bot.action('readyPost', async (ctx) => {
    if (ctx.session.paymentStatus) {
        ctx.session.waitingForPost = true
        await ctx.reply('–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç.')
    } else {
        await ctx.reply('–°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é', Markup.inlineKeyboard(
            [
                [Markup.button.callback('–û–ø–ª–∞—Ç–∏—Ç—å', 'adPost')],
            ]
        ))
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (ctx) => {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏
    if (ctx.message.text.startsWith('/') || ['üìù –†–µ–∫–ª–∞–º–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è', 'üìä –ü—Ä–∞–≤–∏–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'üìå –ü–æ–º–æ—â—å', '–æ–ø–ª–∞—Ç–∏—Ç—å'].includes(ctx.message.text)) {
        return
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞
    if (ctx.session.waitingForPost) {
        ctx.session.messageToForward = ctx.message.text
        ctx.session.messageType = 'text'

        await ctx.reply('–í–∞—à –ø–æ—Å—Ç –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', Markup.inlineKeyboard(
            [
                [Markup.button.callback('>>> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å üì® <<<', 'postForward')],
                [Markup.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', 'cancelPost')]
            ]
        ))
    } else {
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–µ–∑ –æ–ø–ª–∞—Ç—ã
        if (!ctx.session.paymentStatus) {
            await ctx.reply('–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É:',
                Markup.inlineKeyboard([
                    [Markup.button.callback('–û–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é', 'adPost')],
                ])
            )
        }
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
bot.on('photo', async (ctx) => {
    if (ctx.session.waitingForPost) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–æ—Ç–æ –∏ –ø–æ–¥–ø–∏—Å—å
        ctx.session.messageToForward = {
            photoId: ctx.message.photo[ctx.message.photo.length - 1].file_id,
            caption: ctx.message.caption || ''
        }
        ctx.session.messageType = 'photo'

        await ctx.reply('–í–∞—à –ø–æ—Å—Ç —Å —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', Markup.inlineKeyboard(
            [
                [Markup.button.callback('>>> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å üì® <<<', 'postForward')],
                [Markup.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', 'cancelPost')]
            ]
        ))
    } else {
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–µ–∑ –æ–ø–ª–∞—Ç—ã
        if (!ctx.session.paymentStatus) {
            await ctx.reply('–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É:',
                Markup.inlineKeyboard([
                    [Markup.button.callback('–û–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é', 'adPost')],
                ])
            )
        }
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–µ–æ
bot.on('video', async (ctx) => {
    if (ctx.session.waitingForPost) {
        ctx.session.messageToForward = {
            videoId: ctx.message.video.file_id,
            caption: ctx.message.caption || ''
        }
        ctx.session.messageType = 'video'

        await ctx.reply('–í–∞—à –ø–æ—Å—Ç —Å –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', Markup.inlineKeyboard(
            [
                [Markup.button.callback('>>> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å üì® <<<', 'postForward')],
                [Markup.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', 'cancelPost')]
            ]
        ))
    } else {
        // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–µ–∑ –æ–ø–ª–∞—Ç—ã
        if (!ctx.session.paymentStatus) {
            await ctx.reply('–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É:',
                Markup.inlineKeyboard([
                    [Markup.button.callback('–û–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é', 'adPost')],
                ])
            )
        }
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
bot.on('document', async (ctx) => {
    if (ctx.session.waitingForPost) {
        ctx.session.messageToForward = {
            documentId: ctx.message.document.file_id,
            caption: ctx.message.caption || ''
        }
        ctx.session.messageType = 'document'

        await ctx.reply('–í–∞—à –¥–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', Markup.inlineKeyboard(
            [
                [Markup.button.callback('>>> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å üì® <<<', 'postForward')],
                [Markup.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', 'cancelPost')]
            ]
        ))
    } else {
        // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–µ–∑ –æ–ø–ª–∞—Ç—ã
        if (!ctx.session.paymentStatus) {
            await ctx.reply('–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É:',
                Markup.inlineKeyboard([
                    [Markup.button.callback('–û–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é', 'adPost')],
                ])
            )
        }
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
bot.action('postForward', async (ctx) => {
    try {
        if (!ctx.session.paymentStatus) {
            return await ctx.reply('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –æ–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é.')
        }

        if (!ctx.session.messageToForward) {
            return await ctx.reply('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.')
        }

        const chatId = process.env.FORWARD_CHAT_ID

        // –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        switch (ctx.session.messageType) {
            case 'text':
                await bot.telegram.sendMessage(chatId, ctx.session.messageToForward)
                break

            case 'photo':
                await bot.telegram.sendPhoto(chatId,
                    ctx.session.messageToForward.photoId,
                    { caption: ctx.session.messageToForward.caption }
                )
                break

            case 'video':
                await bot.telegram.sendVideo(chatId,
                    ctx.session.messageToForward.videoId,
                    { caption: ctx.session.messageToForward.caption }
                )
                break

            case 'document':
                await bot.telegram.sendDocument(chatId,
                    ctx.session.messageToForward.documentId,
                    { caption: ctx.session.messageToForward.caption }
                )
                break
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–ø–ª–∞—Ç–∏—Ç—å —Å–Ω–æ–≤–∞ –¥–ª—è –Ω–æ–≤–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        ctx.session.paymentStatus = false
        ctx.session.waitingForPost = false
        ctx.session.messageToForward = null
        ctx.session.messageType = null

        await ctx.reply('‚úÖ –í–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! –î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–æ–≤–∞ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É.',
            Markup.inlineKeyboard([
                [Markup.button.callback('–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –µ—â–µ –æ–¥–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ', 'adPost')],
            ])
        )

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error)
        await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @pravodoc_ru.')
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
bot.action('cancelPost', async (ctx) => {
    ctx.session.waitingForPost = false
    ctx.session.messageToForward = null
    ctx.session.messageType = null

    // –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —É–∂–µ –±—ã–ª–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
    if (ctx.session.paymentStatus) {
        await ctx.reply('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ì–æ—Ç–æ–≤–æ" —Å–Ω–æ–≤–∞.',
            Markup.inlineKeyboard([
                [Markup.button.callback('>>> –ì–æ—Ç–æ–≤–æ? –ñ–º–∏ üé¨ <<<', 'readyPost')],
            ])
        )
    } else {
        // –ï—Å–ª–∏ –æ–ø–ª–∞—Ç—ã –Ω–µ –±—ã–ª–æ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–ø–ª–∞—Ç–∏—Ç—å
        await ctx.reply('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É:',
            Markup.inlineKeyboard([
                [Markup.button.callback('–û–ø–ª–∞—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é', 'adPost')],
            ])
        )
    }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
bot.catch((err, ctx) => {
    console.error(`–û—à–∏–±–∫–∞ –¥–ª—è ${ctx.updateType}:`, err)
    ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @pravodoc_ru.')
})

bot.launch()

// Enable graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'))
process.once('SIGTERM', () => bot.stop('SIGTERM'))