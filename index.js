const {Telegraf, Markup} = require('telegraf')
require('dotenv').config()
const help = require('./help')
const description = require('./description')
const callback = require('./callback')


const bot = new Telegraf(process.env.BOT_TOKEN)         //ะขะพะบะตะฝ ะฑะพัะฐ


bot.start(async (ctx) => await ctx.reply(`ะัะธะฒะตั! ${ctx.from.first_name ? ctx.from.first_name : 'ะะตะทะฝะฐะบะพะผะตั'}, ะพะฑัะทะฐัะตะปัะฝะพ ะพะทะฝะฐะบะพะผัั ั ะฟัะฐะฒะธะปะฐะผะธ ะฟัะฑะปะธะบะฐัะธะธ`, Markup.keyboard([
    ['๐ ะะตะบะปะฐะผะฝะฐั ะฟัะฑะปะธะบะฐัะธั'],
    ['๐ ะัะฐะฒะธะปะฐ ะฟัะฑะปะธะบะฐัะธะธ', '๐ ะะพะผะพัั'],

]).resize()))
bot.help((ctx) => ctx.reply(help.helpcommands))
bot.command('post', async (ctx) => {
    await ctx.reply((description.description), Markup.inlineKeyboard(
        [
            [Markup.button.callback('ะัะฑะปะธะบะฐัะธั ัะตะบะปะฐะผะฝัั ะฟัะตะดะปะพะถะตะฝะธะน', 'adPost')],
        ]
    ))
})
bot.action('adPost', async (ctx) => {
    await ctx.answerCbQuery()
    return ctx.replyWithInvoice(getInvoice(ctx.from.id))          //  ะผะตัะพะด replyWithInvoice ะดะปั ะฒัััะฐะฒะปะตะฝะธั ััะตัะฐ
})

bot.hears('๐ ะะตะบะปะฐะผะฝะฐั ะฟัะฑะปะธะบะฐัะธั', async (ctx) => {
    return ctx.replyWithInvoice(getInvoice(ctx.from.id))          //  ะผะตัะพะด replyWithInvoice ะดะปั ะฒัััะฐะฒะปะตะฝะธั ััะตัะฐ


})
bot.hears('๐ ะัะฐะฒะธะปะฐ ะฟัะฑะปะธะบะฐัะธะธ', (ctx) => ctx.reply(description.description))        //ะัะฐะฒะธะปะฐ ะฟัะฑะปะธะบะฐัะธะธ ัะพะพะฑัะตะฝะธะน ะฒ ัะตะปะตะณัะฐะผ ะบะฐะฝะฐะปะต
bot.hears('๐ ะะพะผะพัั', (ctx) => ctx.reply(help.helpcommands))            //ะกะพะพะฑัะตะฝะธะต ะฟะพะผะพัะธ ะฟัะธ ะฒะฒะพะดะต ะบะพะผะฐะฝะดั /help


const getInvoice = (id) => {
    const invoice = {
        chat_id: id,
        provider_token: process.env.PROVIDER_TOKEN,  //ะขะพะบะตะฝ ะฒัะดะฐะฝะฝัะน BotFather ะดะปั ะฟัะพะฒะฐะนะดะตัะฐ ะพะฟะปะฐัั
        start_parameter: 'get_access', //ะฃะฝะธะบะฐะปัะฝัะน ะฟะฐัะฐะผะตัั ะณะปัะฑะธะฝะฝัั ัััะปะพะบ. ะัะปะธ ะพััะฐะฒะธัั ะฟะพะปะต ะฟััััะผ, ะฟะตัะตะฐะดัะตัะพะฒะฐะฝะฝัะต ะบะพะฟะธะธ ะพัะฟัะฐะฒะปะตะฝะฝะพะณะพ ัะพะพะฑัะตะฝะธั ะฑัะดัั ะธะผะตัั ะบะฝะพะฟะบั ยซะะฟะปะฐัะธััยป, ะฟะพะทะฒะพะปััััั ะฝะตัะบะพะปัะบะธะผ ะฟะพะปัะทะพะฒะฐัะตะปัะผ ะฟัะพะธะทะฒะพะดะธัั ะพะฟะปะฐัั ะฝะตะฟะพััะตะดััะฒะตะฝะฝะพ ะธะท ะฟะตัะตััะปะฐะตะผะพะณะพ ัะพะพะฑัะตะฝะธั, ะธัะฟะพะปัะทัั ะพะดะธะฝ ะธ ัะพั ะถะต ััะตั. ะัะปะธ ะฝะต ะฟัััะพ, ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะฝัะต ะบะพะฟะธะธ ะพัะฟัะฐะฒะปะตะฝะฝะพะณะพ ัะพะพะฑัะตะฝะธั ะฑัะดัั ะธะผะตัั ะบะฝะพะฟะบั URL ั ะณะปัะฑะพะบะพะน ัััะปะบะพะน ะฝะฐ ะฑะพัะฐ (ะฒะผะตััะพ ะบะฝะพะฟะบะธ ะพะฟะปะฐัั) ัะพ ะทะฝะฐัะตะฝะธะตะผ, ะธัะฟะพะปัะทัะตะผัะผ ะฒ ะบะฐัะตััะฒะต ะฝะฐัะฐะปัะฝะพะณะพ ะฟะฐัะฐะผะตััะฐ.
        title: 'ะัะฑะปะธะบะฐัะธั ะพะฑััะฒะปะตะฝะธั', // ะะฐะทะฒะฐะฝะธะต ะฟัะพะดัะบัะฐ, 1-32 ัะธะผะฒะพะปะฐ
        description: 'ะัะฑะปะธะบะฐัะธั ะพะดะฝะพะณะพ ะพะฑััะฒะปะตะฝะธั ะฒ ัะตะปะตะณัะฐะผ ะบะฐะฝะฐะปะต @baraxolka_krd', // ะะฟะธัะฐะฝะธะต ะฟัะพะดัะบัะฐ, 1-255 ะทะฝะฐะบะพะฒ
        currency: 'RUB', // ะขัะตัะฑัะบะฒะตะฝะฝัะน ะบะพะด ะฒะฐะปััั ISO 4217
        protect_content: true, // ะัะธ ะฟะตัะตะดะฐัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฟัะธะปะพะถะตะฝะธั ะดะปั ะพะฟะปะฐัั ะฟัะธะปะพะถะตะฝะธะต ะดะพะปะถะฝะพ ะฟัะตะดะพััะฐะฒะธัั ะฒะพะทะผะพะถะฝะพััั ะพัะผะตะฝะธัั ะฟะปะฐัะตะถ ะธะปะธ ะพัะผะตะฝะธัั ะฟัะธะปะพะถะตะฝะธะต ะดะปั ะพะฟะปะฐัั.
        prices: [{label: 'ะะฟะปะฐัะฐ ะทะฐ ะฟัะฑะปะธะบะฐัะธั ะพะฑััะฒะปะตะฝะธั', amount: 100 * 100}], // ะะฐะทะฑะธะฒะบะฐ ัะตะฝ, ัะตัะธะฐะปะธะทะพะฒะฐะฝะฝัะน ัะฟะธัะพะบ ะบะพะผะฟะพะฝะตะฝัะพะฒ ะฒ ัะพัะผะฐัะต JSON 100 ะบะพะฟะตะตะบ * 100 = 100 ััะฑะปะตะน
        payload: { // ะะพะปะตะทะฝัะต ะดะฐะฝะฝัะต ััะตัะฐ-ัะฐะบัััั, ะพะฟัะตะดะตะปะตะฝะฝัะต ะฑะพัะพะผ, 1โ128 ะฑะฐะนั. ะญัะพ ะฝะต ะฑัะดะตั ะพัะพะฑัะฐะถะฐัััั ะฟะพะปัะทะพะฒะฐัะตะปั, ะธัะฟะพะปัะทัะนัะต ะตะณะพ ะดะปั ัะฒะพะธั ะฒะฝัััะตะฝะฝะธั ะฟัะพัะตััะพะฒ.
            unique_id: `${id}_${Number(new Date())}`,
            provider_token: process.env.PROVIDER_TOKEN      //ะขะพะบะตะฝ ะฒัะดะฐะฝะฝัะน BotFather ะดะปั ะฟัะพะฒะฐะนะดะตัะฐ ะพะฟะปะฐัั
        }
    }

    return invoice
}

bot.use(Telegraf.log())

bot.hears('ะพะฟะปะฐัะธัั', (ctx) => {  // ััะพ ะพะฑัะฐะฑะพััะธะบ ะบะพะฝะบัะตัะฝะพะณะพ ัะตะบััะฐ, ะดะฐะฝะฝะพะผ ัะปััะฐะต ััะพ - "ะพะฟะปะฐัะธัั"
    return ctx.replyWithInvoice(getInvoice(ctx.from.id)) //  ะผะตัะพะด replyWithInvoice ะดะปั ะฒัััะฐะฒะปะตะฝะธั ััะตัะฐ
})


bot.on('pre_checkout_query', (ctx) => ctx.answerPreCheckoutQuery(true)) // ะพัะฒะตั ะฝะฐ ะฟัะตะดะฒะฐัะธัะตะปัะฝัะน ะทะฐะฟัะพั ะฟะพ ะพะฟะปะฐัะต

bot.on('successful_payment', async (ctx) => {

    await ctx.reply((callback.callback), Markup.inlineKeyboard(      ////ะกะพะพะฑัะตะฝะธะต ะฒะพะทะฒัะฐัะฐััะตะตัั ะฟะพัะปะต ะพะฟะปะฐัั
        [
            [Markup.button.callback('>>> ะะพัะพะฒะพ? ะะผะธ ๐ฌ <<<', 'readyPost')],

        ]
    ))

    bot.action('readyPost', async (ctx) => {

        await ctx.reply('ะัะปะธัะฝะพ. ะัะธัะปะธัะต ะผะฝะต ะฒะฐัะต ะพะฑััะฒะปะตะฝะธะต')

    })

    bot.on('message', async (ctx) => {
        const forwardText = ctx.message.text

        await ctx.reply((`${forwardText}`), Markup.inlineKeyboard(                         //ะะตัะตััะปะฐะตะผะพะต ัะพะพะฑัะตะฝะธะต
                [
                    [Markup.button.callback('>>> ะะฟัะฑะปะธะบะพะฒะฐัั ๐จ <<<', 'postForward')],

                ]
            )
        )
    })

    bot.action('postForward', async (ctx) => {
        await ctx.forwardMessage(process.env.FORWADR_CHAT_ID, ctx.chat.id, ctx.forwardText)  // ID ะบะฐะฝะฐะปะฐ ะบัะดะฐ ะฑัะดะตั ะฟะตัะตััะปะบะฐ ัะพะพะฑัะตะฝะธั
        await ctx.reply('ะะฑััะฒะปะตะฝะธะต ะพะฟัะฑะปะธะบะพะฒะฐะฝะพ')
    })
})

bot.launch()


// Enable graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'))
process.once('SIGTERM', () => bot.stop('SIGTERM'))